<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        .container {
            max-width: 1200px;
        }
        .icon-svg {
            stroke-width: 2.5;
        }
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Toast/Message Area -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="relative">

        <!-- 1. LOADING SCREEN -->
        <div id="loading-screen" class="min-h-screen flex items-center justify-center bg-gray-50 transition-opacity duration-300">
            <div class="flex items-center space-x-3 text-indigo-600">
                <div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
                <span class="text-xl font-medium">Initializing Inventory System...</span>
            </div>
        </div>

        <!-- 2. PROFILE SETUP SCREEN -->
        <div id="setup-screen" class="hidden min-h-screen items-center justify-center bg-gray-100 p-4 transition-opacity duration-300">
            <div class="w-full max-w-md bg-white p-8 shadow-2xl rounded-xl border border-indigo-100">
                <div class="flex justify-center mb-6">
                    <i data-lucide="settings" class="w-12 h-12 text-indigo-500 icon-svg"></i>
                </div>
                <h2 class="text-2xl font-bold text-center mb-2 text-gray-800">Welcome Setup</h2>
                <p class="text-center text-gray-600 mb-6 text-sm">
                    Your temporary User ID: <span id="display-user-id" class="font-mono text-xs bg-indigo-50 p-1 rounded"></span>
                </p>

                <form id="profile-setup-form" class="space-y-4">
                    <div>
                        <label for="setup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input id="setup-name" type="text" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="e.g., John Smith">
                    </div>
                    <div>
                        <label for="setup-role" class="block text-sm font-medium text-gray-700">Select Role</label>
                        <select id="setup-role" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-lg shadow-sm">
                            <option value="student">Student (Borrower)</option>
                            <option value="admin">Admin (Inventory Manager)</option>
                        </select>
                    </div>

                    <button type="submit" id="setup-submit-btn"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Continue to Dashboard
                    </button>
                </form>
            </div>
        </div>

        <!-- 3. MAIN DASHBOARD CONTENT -->
        <div id="main-dashboard" class="hidden min-h-screen transition-opacity duration-300">
            <nav class="bg-white shadow-md sticky top-0 z-10">
                <div class="container mx-auto p-4 flex justify-between items-center">
                    <h1 class="text-2xl font-extrabold text-indigo-600 flex items-center">
                        <i data-lucide="box" class="w-6 h-6 mr-2 icon-svg"></i> Smart Inventory
                    </h1>
                    <div class="flex items-center space-x-4">
                        <div class="hidden sm:block text-right">
                            <p class="text-sm font-semibold text-gray-800" id="header-user-name"></p>
                            <p class="text-xs text-indigo-500 capitalize" id="header-user-role"></p>
                        </div>
                        <button onclick="handleLogout()"
                            class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-full transition shadow-lg"
                            title="Logout">
                            <i data-lucide="log-out" class="w-5 h-5 icon-svg"></i>
                        </button>
                    </div>
                </div>
            </nav>

            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                <!-- ADMIN DASHBOARD -->
                <div id="admin-view" class="hidden space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-900">Admin Dashboard</h2>

                    <!-- Add Item Form -->
                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-green-500 icon-svg"></i> Add New Item
                        </h3>
                        <form id="add-item-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" name="itemId" placeholder="Item ID (e.g., LAPT-001)" required class="input-field">
                            <input type="text" name="name" placeholder="Item Name (e.g., Dell XPS 13)" required class="input-field">
                            <input type="text" name="category" placeholder="Category (e.g., Electronics)" required class="input-field">
                            <input type="number" name="quantity" placeholder="Quantity" min="0" required class="input-field">
                            <input type="number" name="threshold" placeholder="Low Stock Threshold" min="0" required class="input-field">

                            <div class="lg:col-span-1 sm:col-span-2">
                                <button type="submit" id="add-item-btn"
                                    class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Add Item
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Admin Reports -->
                    <div id="admin-reports-container" class="space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Management Reports</h2>
                        <div id="admin-reports-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Report Cards rendered here -->
                        </div>
                        <div id="admin-detailed-reports" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Detailed Low Stock and Overdue Reports rendered here -->
                        </div>
                    </div>

                    <!-- Inventory Table for Admin -->
                    <div id="admin-item-table-container">
                        <!-- Item Table rendered here -->
                    </div>
                </div>

                <!-- STUDENT DASHBOARD -->
                <div id="student-view" class="hidden space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-900">Student Dashboard</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Borrow Item Form -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="user" class="w-5 h-5 mr-2 text-indigo-500 icon-svg"></i> Borrow Item
                            </h3>
                            <form id="borrow-form" class="space-y-4">
                                <div>
                                    <label for="borrow-item-id" class="block text-sm font-medium text-gray-700">Item ID to Borrow</label>
                                    <select id="borrow-item-id" required class="input-field select-field">
                                        <option value="" disabled selected>Select an available item ID</option>
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="borrow-duration" class="block text-sm font-medium text-gray-700">Borrow Duration (Days)</label>
                                    <input id="borrow-duration" type="number" value="7" min="1" max="30" required class="input-field">
                                </div>
                                <button type="submit" id="borrow-btn"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                    Borrow Item
                                </button>
                            </form>
                        </div>
                        <!-- User Transaction History -->
                        <div class="lg:col-span-2">
                            <div id="student-transaction-history" class="bg-white p-6 rounded-xl shadow-xl">
                                <!-- Transaction History rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Table for Student -->
                    <div id="student-item-table-container">
                        <!-- Item Table rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Core Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // UPDATED: Added getDocs and query for initial data check
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, updateDoc, addDoc, serverTimestamp, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let userId = null;
        let userProfile = null;
        let items = [];
        let transactions = [];

        // --- Utility Functions ---

        /** Shows a specific screen and hides others. */
        const showScreen = (screenId) => {
            ['loading-screen', 'setup-screen', 'main-dashboard'].forEach(id => {
                const element = document.getElementById(id);
                element.classList.add('hidden');
                element.style.display = 'none';
                if (id === 'setup-screen' || id === 'loading-screen') element.classList.remove('flex');
            });

            const targetElement = document.getElementById(screenId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                targetElement.style.display = 'block';
                if (screenId === 'setup-screen' || screenId === 'loading-screen') targetElement.classList.add('flex');
                if (screenId === 'main-dashboard') {
                     // Rerender icons after showing the screen
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        };

        /** Renders a toast message. */
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const colorMap = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `${colorMap[type]} text-white p-4 rounded-lg shadow-lg mb-2 transition-all duration-300 transform translate-x-full opacity-0`;
            toast.textContent = message;

            container.prepend(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        // --- Data Seeding Function (NEW) ---
        const checkAndSeedData = async () => {
            const itemsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
            
            try {
                // Check if collection has any documents
                const q = query(itemsCollectionRef);
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    console.log("No initial items found. Seeding data...");

                    const initialItems = [
                        // Initial data added here
                        { itemId: 'LAPT-001', name: 'MacBook Pro 14"', quantity: 5, category: 'Electronics', threshold: 2 },
                        { itemId: 'TOOL-101', name: 'Digital Multimeter', quantity: 15, category: 'Tools', threshold: 5 },
                        { itemId: 'BOOK-456', name: 'Data Structures Textbook', quantity: 0, category: 'Literature', threshold: 5 },
                        { itemId: 'SENS-005', name: 'Arduino Sensor Kit', quantity: 8, category: 'Electronics', threshold: 3 }
                    ];

                    // Write all docs concurrently
                    await Promise.all(initialItems.map(item => 
                        setDoc(doc(itemsCollectionRef, item.itemId), item)
                    ));

                    console.log("Initial data seeding complete.");
                } else {
                    console.log("Initial items found. Skipping data seeding.");
                }
            } catch (e) {
                console.error("Error during data seeding:", e);
            }
        };

        // --- Authentication & Initialization ---

        const handleAuth = async (uid) => {
            userId = uid;
            document.getElementById('display-user-id').textContent = userId.substring(0, 8) + '...';

            // FIX: Run data seeding only after successful authentication
            await checkAndSeedData(); 

            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
            const docSnap = await getDoc(profileRef);

            if (docSnap.exists()) {
                userProfile = { id: uid, ...docSnap.data() };
                setupDataListeners();
                renderDashboard();
                showScreen('main-dashboard');
            } else {
                userProfile = { role: 'unassigned' };
                showScreen('setup-screen');
            }
        };

        const initFirebase = () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // FIX: Removed checkAndSeedData() from here to prevent the permission error.

                // setLogLevel('Debug'); // Uncomment for debugging Firestore logs

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        await handleAuth(user.uid);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showToast("Failed to initialize system. Check console for details.", 'error');
                showScreen('setup-screen'); // Show something to the user even on failure
            }
        };

        window.onload = initFirebase;

        window.handleLogout = async () => {
            try {
                await auth.signOut();
                userProfile = null;
                showScreen('loading-screen'); // Re-trigger auth flow
                showToast("Logged out successfully!", 'info');
            } catch (e) {
                showToast("Error logging out.", 'error');
            }
        };

        // --- Data Listeners ---

        const setupDataListeners = () => {
            if (!db) return;

            // 1. Items Listener (Public/Shared Data)
            const itemsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
            onSnapshot(itemsCollectionRef, (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            }, (error) => console.error("Error listening to items:", error));

            // 2. Transactions Listener (Public/Shared Data)
            const transactionsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            onSnapshot(transactionsCollectionRef, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            }, (error) => console.error("Error listening to transactions:", error));
        };

        // --- Rendering Logic ---

        const renderDashboard = () => {
            if (!userProfile) return;

            // Update Header
            document.getElementById('header-user-name').textContent = userProfile.name;
            document.getElementById('header-user-role').innerHTML = `${userProfile.role} - ID: <span class="font-mono">${userProfile.id.substring(0, 8)}...</span>`;

            // Toggle Admin/Student View
            const isAdmin = userProfile.role === 'admin';
            document.getElementById('admin-view').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('student-view').style.display = isAdmin ? 'none' : 'block';

            if (isAdmin) {
                renderReports(items, transactions);
                renderItemTable(items, 'admin-item-table-container');
            } else {
                renderBorrowForm(items);
                renderTransactionHistory(userId, transactions);
                renderItemTable(items, 'student-item-table-container');
            }
        };

        const renderItemTable = (itemsToRender, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;

            const sortedItems = [...itemsToRender].sort((a, b) => a.name.localeCompare(b.name));
            let html = `
                <div class="bg-white p-6 rounded-xl shadow-xl overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="box" class="w-5 h-5 mr-2 text-indigo-500 icon-svg"></i> Current Inventory (${itemsToRender.length} items)
                    </h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Threshold</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            if (sortedItems.length === 0) {
                 html += `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No items found in the inventory.</td></tr>`;
            } else {
                sortedItems.forEach(item => {
                    const isLow = item.quantity <= item.threshold;
                    const statusClass = isLow ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                    const rowClass = isLow ? 'bg-yellow-50' : '';
                    html += `
                        <tr class="${rowClass}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.itemId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right">${item.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${item.threshold}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${isLow ? 'LOW' : 'OK'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        const renderReports = (items, transactions) => {
            const todayStr = new Date().toISOString().split('T')[0];

            const lowStockItems = items.filter(i => i.quantity <= i.threshold);
            const overdueTransactions = transactions.filter(t => t.returnDate && t.returnDate < todayStr);
            const totalTransactions = transactions.length;

            // --- Cards ---
            const renderCard = (title, value, iconName, color) => `
                <div class="p-5 bg-white rounded-xl shadow-xl border-l-4 border-${color}-500 transition hover:shadow-2xl">
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-medium text-gray-500 truncate uppercase">${title}</p>
                        <i data-lucide="${iconName}" class="w-6 h-6 text-${color}-500 icon-svg"></i>
                    </div>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${value}</p>
                </div>
            `;

            document.getElementById('admin-reports-cards').innerHTML = `
                ${renderCard('Total Transactions', totalTransactions, 'trending-up', 'indigo')}
                ${renderCard('Low Stock Items', lowStockItems.length, 'zap', 'yellow')}
                ${renderCard('Overdue Returns', overdueTransactions.length, 'clock', 'red')}
            `;

            // --- Detailed Reports ---
            const detailedReports = document.getElementById('admin-detailed-reports');
            let detailedHtml = `
                <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-yellow-500">
                    <h3 class="text-xl font-bold text-yellow-700 mb-4 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i> Low Stock Items
                    </h3>
                    <div class="max-h-60 overflow-y-auto divide-y divide-gray-100">
                        ${lowStockItems.length > 0 ?
                            lowStockItems.map(item => `
                                <div class="py-2 flex justify-between text-sm">
                                    <span class="font-semibold text-gray-800">${item.name} (${item.itemId})</span>
                                    <span class="text-yellow-600">Qty: ${item.quantity} (Threshold: ${item.threshold})</span>
                                </div>
                            `).join('')
                            : '<p class="text-gray-500">No items are currently running low on stock. Great job!</p>'}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-red-500">
                    <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                        <i data-lucide="clock" class="w-5 h-5 mr-2"></i> Overdue Transactions
                    </h3>
                    <div class="max-h-60 overflow-y-auto divide-y divide-gray-100">
                        ${overdueTransactions.length > 0 ?
                            overdueTransactions.map(t => `
                                <div class="py-2 flex justify-between text-sm">
                                    <span class="font-semibold text-gray-800">${t.itemName} (${t.itemId})</span>
                                    <span class="text-red-600">User: ${t.userName} | Due: ${t.returnDate}</span>
                                </div>
                            `).join('')
                            : '<p class="text-gray-500">No transactions are currently overdue. All items returned on time!</p>'}
                    </div>
                </div>
            `;
            detailedReports.innerHTML = detailedHtml;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        const renderBorrowForm = (items) => {
            const select = document.getElementById('borrow-item-id');
            if (!select) return;

            // Filter items that are in stock
            const inStockItems = items.filter(i => i.quantity > 0);

            let optionsHtml = '<option value="" disabled selected>Select an available item ID</option>';
            inStockItems.forEach(item => {
                optionsHtml += `<option value="${item.itemId}">
                    ${item.itemId} - ${item.name} (Qty: ${item.quantity})
                </option>`;
            });
            select.innerHTML = optionsHtml;
        };

        const renderTransactionHistory = (currentUserId, transactions) => {
            const container = document.getElementById('student-transaction-history');
            if (!container) return;

            const userTransactions = [...transactions]
                .filter(t => t.userId === currentUserId)
                .sort((a, b) => (b.checkoutDate?.seconds || 0) - (a.checkoutDate?.seconds || 0));

            let html = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="clock" class="w-5 h-5 mr-2 text-indigo-500 icon-svg"></i> Your Transaction History (${userTransactions.length})
                </h3>
                <div class="max-h-96 overflow-y-auto">
            `;

            if (userTransactions.length === 0) {
                html += '<p class="text-gray-500">You haven\'t borrowed any items yet.</p>';
            } else {
                html += `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrowed</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                userTransactions.forEach(t => {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const isOverdue = t.returnDate < todayStr;
                    const dueClass = isOverdue ? 'text-red-600' : 'text-green-600';
                    const rowClass = isOverdue ? 'bg-red-50' : '';
                    const borrowDate = t.checkoutDate ? new Date(t.checkoutDate.seconds * 1000).toLocaleDateString() : 'N/A';

                    html += `
                        <tr class="${rowClass}">
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${t.itemName}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${borrowDate}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold ${dueClass}">${t.returnDate}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${isOverdue ? 'OVERDUE' : 'Borrowed'}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            }
            html += `</div>`;
            container.innerHTML = html;
        };


        // --- Firestore CRUD Operations ---

        document.getElementById('profile-setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('setup-name').value.trim();
            const role = document.getElementById('setup-role').value;
            const btn = document.getElementById('setup-submit-btn');

            if (!name) {
                showToast('Please enter your name.', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Saving Profile...';
            
            const newProfile = { name, role, userId };
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');

            try {
                await setDoc(profileRef, newProfile);
                userProfile = { id: userId, ...newProfile };
                setupDataListeners();
                renderDashboard();
                showScreen('main-dashboard');
                showToast('Profile saved. Welcome!', 'success');
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast('Error saving profile.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Continue to Dashboard';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        });


        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('add-item-btn');

            const itemData = {
                itemId: form.itemId.value.trim(),
                name: form.name.value.trim(),
                category: form.category.value.trim(),
                quantity: parseInt(form.quantity.value),
                threshold: parseInt(form.threshold.value),
            };

            if (items.some(i => i.itemId === itemData.itemId)) {
                showToast(`Item ID ${itemData.itemId} already exists.`, 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Adding Item...';

            const itemsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
            try {
                await setDoc(doc(itemsCollectionRef, itemData.itemId), itemData);
                showToast(`'${itemData.name}' added successfully!`, 'success');
                form.reset();
            } catch (e) {
                console.error("Error adding item:", e);
                showToast(`Error adding item: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Add Item';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        });

        document.getElementById('borrow-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('borrow-btn');

            const itemId = form['borrow-item-id'].value;
            const durationDays = parseInt(form['borrow-duration'].value);

            if (!itemId) {
                showToast('Please select an item to borrow.', 'error');
                return;
            }

            const item = items.find(i => i.itemId === itemId);
            if (!item || item.quantity <= 0) {
                showToast('Error: Item is out of stock or not found.', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Borrowing...';

            // 1. Calculate return date
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + durationDays);

            const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'items', item.itemId);
            const transactionsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');

            try {
                // 2. Update item quantity
                await updateDoc(itemRef, {
                    quantity: item.quantity - 1
                });
                
                // 3. Add transaction record
                await addDoc(transactionsCollectionRef, {
                    userId: userId,
                    userName: userProfile.name,
                    itemId: item.itemId,
                    itemName: item.name,
                    checkoutDate: serverTimestamp(),
                    returnDate: dueDate.toISOString().split('T')[0], // YYYY-MM-DD string
                    status: 'borrowed',
                });

                showToast(`'${item.name}' borrowed successfully! Due: ${dueDate.toLocaleDateString()}`, 'success');
                form.reset();
            } catch (e) {
                console.error("Error checking out item:", e);
                showToast(`Error: Could not complete checkout. ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Borrow Item';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        });

        // Set up global styles for input fields
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .input-field {
                    @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500;
                }
                .select-field {
                    @apply pl-3 pr-10 py-2 text-base;
                }
            </style>
        `);
    </script>
</body>
</html>
